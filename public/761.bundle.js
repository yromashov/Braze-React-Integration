"use strict";(self.webpackChunkbraze_web_sdk_tutorial=self.webpackChunkbraze_web_sdk_tutorial||[]).push([[761],{761:(i,e,t)=>{t.r(e),t.d(e,{default:()=>f});var n=t(3774),s=t(2893),o=t(3552),r=t(2367),a=t(5966),u=t(7615),h=t(5319);class c{constructor(i,e,t,n,s,o,r,a,u,h){this.Pe=i,this.We=e,this.Re=t,this.Ve=n+"/safari/"+e,this.Ye=s||"/service-worker.js",this.Ke=o,this.wt=r,this.Qe=a||!1,this.Xe=u||!1,this.h=h,this.Ze="serviceWorker"in navigator&&"undefined"!=typeof ServiceWorkerRegistration&&"showNotification"in ServiceWorkerRegistration.prototype&&"PushManager"in window,this.hn="safari"in window&&"pushNotification"in window.safari&&"function"==typeof window.safari.pushNotification.permission&&"function"==typeof window.safari.pushNotification.requestPermission}dn(){return this.Xe}isPushSupported(){return this.Ze||this.hn}isPushBlocked(){const i=this.isPushSupported()&&"Notification"in window&&null!=window.Notification&&null!=window.Notification.permission&&"denied"===window.Notification.permission,e=this.isPushSupported()&&(!("Notification"in window)||null==window.Notification);return i||e}isPushPermissionGranted(){return this.isPushSupported()&&"Notification"in window&&null!=window.Notification&&null!=window.Notification.permission&&"granted"===window.Notification.permission}Ti(){return!this.isPushBlocked()&&this.isPushSupported()&&!this.isPushPermissionGranted()}fn(i,e,t,n,s){i.unsubscribe().then((i=>{i?this.pn(e,t,n,s):(r.Z.D.error("Failed to unsubscribe device from push."),"function"==typeof s&&s(!1))})).catch((i=>{r.Z.D.error("Push unsubscription error: "+i),"function"==typeof s&&s(!1)}))}wn(i,e,t){const n=(i=>{if("string"==typeof i)return i;if(0!==i.endpoint.indexOf("https://android.googleapis.com/gcm/send"))return i.endpoint;let e=i.endpoint;return i.bn&&-1===i.endpoint.indexOf(i.bn)&&(e=i.endpoint+"/"+i.bn),e})(i);let s=null,o=null;if(null!=i.getKey)try{s=btoa(String.fromCharCode.apply(null,new Uint8Array(i.getKey("p256dh")))),o=btoa(String.fromCharCode.apply(null,new Uint8Array(i.getKey("auth"))))}catch(i){if("invalid arguments"!==i.message)throw i}const r=(i=>{let e;return i.options&&(e=i.options.applicationServerKey)&&e.byteLength&&e.byteLength>0?btoa(String.fromCharCode.apply(null,new Uint8Array(e))).replace(/\+/g,"-").replace(/\//g,"_"):null})(i);this.Pe.gn(n,t,s,o,r),n&&"function"==typeof e&&e(n,s,o)}yn(){this.Pe.vn(!0)}Pn(i,e){this.Pe.vn(!1),r.Z.D.info(i),"function"==typeof e&&e(!1)}kn(i,e,t,n){if("default"===e.permission)try{window.safari.pushNotification.requestPermission(this.Ve,i,{api_key:this.We,device_id:this.Re.te().id},(e=>{"granted"===e.permission&&this.Pe.setPushNotificationSubscriptionType(u.Z.NotificationSubscriptionTypes.OPTED_IN),this.kn(i,e,t,n)}))}catch(i){this.Pn("Could not request permission for push: "+i,n)}else"denied"===e.permission?this.Pn("The user has blocked notifications from this site, or Safari push is not configured in the Braze dashboard.",n):"granted"===e.permission&&(r.Z.D.info("Device successfully subscribed to push."),this.wn(e.deviceToken,t,new Date))}Sn(i,e,t){const n=n=>{switch(n){case"granted":return void("function"==typeof i&&i());case"default":return void("function"==typeof e&&e());case"denied":return void("function"==typeof t&&t());default:r.Z.D.error("Received unexpected permission result "+n)}};let s=!1;const o=window.Notification.requestPermission((i=>{s&&n(i)}));o?o.then((i=>{n(i)})):s=!0}pn(i,e,t,n){const s={userVisibleOnly:!0};null!=e&&(s.applicationServerKey=e),i.pushManager.subscribe(s).then((i=>{r.Z.D.info("Device successfully subscribed to push."),this.wn(i,t,new Date)})).catch((i=>{this.isPushBlocked()?(r.Z.D.info("Permission for push notifications was denied."),"function"==typeof n&&n(!1)):r.Z.D.error("Push subscription failed: "+i)}))}Dn(){return this.Qe?navigator.serviceWorker.getRegistration():navigator.serviceWorker.register(this.Ye).then((()=>navigator.serviceWorker.ready.then((i=>(i&&"function"==typeof i.update&&i.update().catch((i=>{r.Z.D.info("ServiceWorker update failed: "+i)})),i)))))}_n(i){this.Qe||(i.unregister(),r.Z.D.info("Service worker successfully unregistered."))}subscribe(i,e){if(this.isPushSupported()){if(this.Ze){if(!this.Qe&&null!=window.location){let i=this.Ye;-1===i.indexOf(window.location.host)&&(i=window.location.host+i),-1===i.indexOf(window.location.protocol)&&(i=window.location.protocol+"//"+i);const e=i.substr(0,i.lastIndexOf("/")+1);if(0!==h.SD.Nn().indexOf(e))return void r.Z.D.error("Cannot subscribe to push from a path higher than the service worker location (tried to subscribe from "+window.location.pathname+" but service worker is at "+i+")")}if(this.isPushBlocked())return void this.Pn("Notifications from this site are blocked. This may be a temporary embargo or a permanent denial.",e);if(this.wt&&!this.wt.Wn()&&0===this.wt.Gs())return r.Z.D.info("Waiting for VAPID key from server config before subscribing to push."),void this.wt.An((()=>{this.subscribe(i,e)}));const t=()=>{r.Z.D.info("Permission for push notifications was denied."),"function"==typeof e&&e(!1)},n=()=>{let i="Permission for push notifications was ignored.";this.isPushBlocked()&&(i+=" The browser has automatically blocked further permission requests for a period (probably 1 week)."),r.Z.D.info(i),"function"==typeof e&&e(!0)},c=this.isPushPermissionGranted(),p=()=>{c||this.Pe.setPushNotificationSubscriptionType(u.Z.NotificationSubscriptionTypes.OPTED_IN),this.Dn().then((t=>{if(null==t)return r.Z.D.error("No service worker registration. Set the `manageServiceWorkerExternally` initialization option to false or ensure that your service worker is registered before calling registerPush."),void("function"==typeof e&&e());t.pushManager.getSubscription().then((n=>{let u=null;if(this.wt&&null!=this.wt.Wn()&&(u=r.Z.Un.jn(this.wt.Wn())),n){let h=null,c=null;const p=this.h.I(a.I.q.xn);if(p&&!(0,s.kJ)(p)){let i;try{i=o.Z.Rn(p).Tn}catch(e){i=null}null==i||isNaN(i.getTime())||0===i.getTime()||(h=i,c=new Date(h),c.setMonth(h.getMonth()+6))}null!=u&&n.options&&n.options.applicationServerKey&&n.options.applicationServerKey.byteLength&&n.options.applicationServerKey.byteLength>0&&!(0,s.Xy)(u,new Uint8Array(n.options.applicationServerKey))?(n.options.applicationServerKey.byteLength>12?r.Z.D.info("Device was already subscribed to push using a different VAPID provider, creating new subscription."):r.Z.D.info("Attempting to upgrade a gcm_sender_id-based push registration to VAPID - depending on the browser this may or may not result in the same gcm_sender_id-based subscription."),this.fn(n,t,u,i,e)):n.expirationTime&&new Date(n.expirationTime)<=(new Date).valueOf()?(r.Z.D.info("Push subscription is expired, creating new subscription."),this.fn(n,t,u,i,e)):p&&(0,s.kJ)(p)?this.fn(n,t,u,i,e):null==c?(r.Z.D.info("No push subscription creation date found, creating new subscription."),this.fn(n,t,u,i,e)):c<=(new Date).valueOf()?(r.Z.D.info("Push subscription older than 6 months, creating new subscription."),this.fn(n,t,u,i,e)):(r.Z.D.info("Device already subscribed to push, sending existing subscription to backend."),this.wn(n,i,h))}else this.pn(t,u,i,e)})).catch((i=>{r.Z.D.error("Error checking current push subscriptions: "+i)}))})).catch((i=>{r.Z.D.error("ServiceWorker registration failed: "+i)}))};this.Sn(p,n,t)}else if(this.hn){if(null==this.Ke||""===this.Ke)return void r.Z.D.error("You must supply the safariWebsitePushId initialization option in order to use registerPush on Safari");const t=window.safari.pushNotification.permission(this.Ke);this.kn(this.Ke,t,i,e)}}else r.Z.D.info(this.zn)}unsubscribe(i,e){this.isPushSupported()?this.Ze?navigator.serviceWorker.getRegistration().then((t=>{t&&t.pushManager.getSubscription().then((n=>{n&&(this.yn(),n.unsubscribe().then((n=>{n?(r.Z.D.info("Device successfully unsubscribed from push."),"function"==typeof i&&i()):(r.Z.D.error("Failed to unsubscribe device from push."),"function"==typeof e&&e()),this._n(t)})).catch((i=>{r.Z.D.error("Push unsubscription error: "+i),"function"==typeof e&&e()})))})).catch((i=>{r.Z.D.error("Error unsubscribing from push: "+i),"function"==typeof e&&e()}))})):this.hn&&(this.yn(),r.Z.D.info("Device unsubscribed from push."),"function"==typeof i&&i()):r.Z.D.info(this.zn)}}c.zn="Push notifications are not supported in this browser.";const p={t:!1,pushManager:null,Br:()=>(p.o(),p.pushManager||(p.pushManager=new c(n.ZP.gr(),n.ZP.aa(),n.ZP.ce(),n.ZP.Js(),n.ZP.nn(n.JY.ea),n.ZP.nn(n.JY.na),n.ZP.ir(),n.ZP.nn(n.JY.ra),n.ZP.nn(n.JY.ta),n.ZP.l())),p.pushManager),o:()=>{p.t||(n.ZP.u(p),p.t=!0)},destroy:()=>{p.pushManager=null,p.t=!1}},f=p}}]);
//# sourceMappingURL=761.bundle.js.map